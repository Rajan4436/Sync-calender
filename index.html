<!DOCTYPE html>
<html>
  <head>
    <title>Calendar Sync </title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="fullcalender/main.css">
    <script src="https://code.jquery.com/jquery-3.0.0.min.js"  crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <link href="style.css" rel="stylesheet" type="text/css" />
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  </head>
  <body>

    <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
    <div class="container">
      <a href="/" class="navbar-brand">Book a Meet</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse"
        aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarCollapse">
        <ul id="authenticated-nav" class="navbar-nav mr-auto"></ul>
        <ul class="navbar-nav justify-content-end">
          <li class="nav-item">
            <button class="btn btn-info" id="authorize_button" style="">Authorize & Sync for Google</button>
          </li>
          <li>
            <!-- Button to Open the Modal -->
            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModal">
              Create New event
            </button>
          </li>
          <li id="account-nav" class="nav-item"></li>
        </ul>
      </div>
    </div>
  </nav>


    <div class="container" style="margin-top:30px">
    
      <!--Add buttons to initiate auth sequence and sign out-->

      <pre id="content" style="white-space: pre-wrap;"></pre>

      <p id="loggedUsers"></p>
      <div id='calendar'>Loading...</div>

    </div>


    <!-- The Modal -->
    <div class="modal" id="myModal">

      <div class="modal-dialog">
        <div class="modal-content">

          <!-- Modal Header -->
          <div class="modal-header">
            <h4 class="modal-title">Modal Heading</h4>
            <button type="button" class="close" data-dismiss="modal">&times;</button>
          </div>

          <!-- Modal body -->
          <div class="modal-body">
            <form action="">
              <div class="form-group">
                <label for="description">Select Account:</label>
                <select class="emails form-control">
                  
                </select>
              </div>

              <div class="form-group">
                <label for="email">Title:</label>
                <input type="text" class="form-control" placeholder="Enter email" id="summary">
              </div>

              <div class="form-group">
                <label for="description">Description:</label>
                <textarea class="form-control" placeholder="Add Description" id="description"></textarea>
              </div>

              <div class="form-group">
                <label for="pwd">From:</label>
                <input type="datetime-local" class="form-control" placeholder="Enter password" id="from">
              </div>

              <div class="form-group">
                <label for="pwd">To:</label>
                <input type="datetime-local" class="form-control" placeholder="End Time" id="to">
              </div>

              <div class="form-group">
                <label>Attendees:</label>
                <input type="text" class="form-control" placeholder="Attendees list separated by comma" id="attendees">
              </div>

              <button class="btn btn-primary" id="create-event">Submit</button>
            </form>
          </div>

          <!-- Modal footer -->
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
          </div>

        </div>
      </div>
    </div>

    <script type="text/javascript" src="fullcalender/main.js"></script>
    <script type="text/javascript">

      // Array of API discovery doc URLs for APIs used by the quickstart
      var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];

      // Authorization scopes required by the API; multiple scopes can be
      // included, separated by spaces.
      var SCOPES = "https://www.googleapis.com/auth/calendar";

      var API_KEY = "AIzaSyAVbFO5_YuPRrWDk5SYVjzp7ZFcpEnwoFo"

      var authorizeButton = document.getElementById('authorize_button');
      
      /**
       *  On load, called to load the auth2 library and API client library.
       */
      function handleClientLoad() {
        gapi.load('client:auth2', initClient);
      }

      /**
       *  Initializes the API client library and sets up sign-in state
       *  listeners.
       */
      function initClient() {
        if (gapi.auth2.getAuthInstance()) {
          gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
        }else{
          updateSigninStatus(false)
          authorizeButton.onclick = handleAuthClick;
        }
      }

      /**
       *  Called when the signed in status changes, to update the UI
       *  appropriately. After a sign-in, the API is called.
       */
      function updateSigninStatus(isSignedIn) {
        loggedUsers = JSON.parse(localStorage.getItem("users"))
        var usrs = "<b>Logged In users </b><br> <br>"
        for(u in loggedUsers){ 
          usrs += `${loggedUsers[u].email} <br>`
        }

        $("#loggedUsers").html(usrs)
      }

      function deleteByValue(val, arr) {
        for (var k in arr){
          if ((arr[k].email === val) && (arr[k].type == "google")) {
            if (k != null){
              delete arr[k];
            }
          }
        }

        var filtered = arr.filter(function (el) {
          return el != null;
        });

        return filtered
      }


      logged_users =  JSON.parse(localStorage.getItem("users")) || []
      options = ""
      for (var i = 0; i < logged_users.length; i++) {
        options += `<option value="${logged_users[i].email}-${logged_users[i].type}">${logged_users[i].email} - ${logged_users[i].type} </option>`
      }

      $(".emails").html(options)


      /**
       *  Sign in the user upon button click.
       */
      function handleAuthClick(event){
        gapi.auth2.authorize({
          client_id: "276740170414-sitfpgqiciq46bd268babm6uk8lot6o1.apps.googleusercontent.com",
          scope: SCOPES,
          discoveryDocs: DISCOVERY_DOCS,
          response_type: 'id_token permission email'
        }, function(response) {
          console.log(response)
          if (response.error) {
            // An error happened!
            return;
          }
          
          // The user authorized the application for the scopes requested.
          var accessToken = response.access_token;
          var idToken = response.id_token;

          $.get("https://www.googleapis.com/oauth2/v1/userinfo?alt=json&access_token="+ accessToken, function(res){
            
            if(response.access_token){
              updateSigninStatus(true);
            }
            
            update_event(res.email, accessToken)
          })

         
          // You can also now use gapi.client to perform authenticated requests.
        });
      }


      $("#create-event").on("click", function(en){
        en.preventDefault()
        description = $("#description").val()
        summary = $("#summary").val()
        from = (new Date($("#from").val())).toISOString()
        to = (new Date($("#to").val())).toISOString()
        email = $(".emails").val()
        attendees = $("#attendees").val()
        console.log(email)

        create_event(email.split("-")[0], summary, from, to, description, email.split("-")[1], attendees.split(","))   
        return false;
      })

      function update_event(email, accessToken){
        $.get(`https://www.googleapis.com/calendar/v3/calendars/${email}/events?access_token=${accessToken}`, function(result){
          console.log(result)
      
          events = result.items
          if (events.length > 0) {
            times = []
            for (i = 0; i < events.length; i++) {
              var event = events[i];
              var start = event.start.dateTime;
              var end = event.end.dateTime;
              
              times.push({
                title: event.summary,
                description: event.description,
                start: start,
                end: end
              })
            }

            new_user = {
              email: email,
              type: "google",
              access_token: accessToken
            }

            schedule = { 
              email: email,
              type: "google",
              events: times
            }


            users =  JSON.parse(localStorage.getItem("users")) || []
            schedules = JSON.parse(localStorage.getItem("schedules")) || []

            // Get current user schedule if exists delete it and add updated record
          
            schedules = deleteByValue(email, schedules)
            schedules.push(schedule)
            localStorage.setItem("schedules", JSON.stringify(schedules))
            
            users = deleteByValue(email, users)
            users.push(new_user)
            localStorage.setItem('users', JSON.stringify(users));

            var calendarEl = document.getElementById('calendar');

            var calendar = new FullCalendar.Calendar(calendarEl, {
              initialDate: '2020-10-12',
              editable: true,
              selectable: true,
              lazyFetching: false,
              businessHours: true,
              dayMaxEvents: true, // allow "more" link when too many events
              events: arrangeEvents()
            });

            calendar.render();
            
          } else {
            return [];
          }
        })
      }

      function create_event(email, summary, from, to, description, account_type, attendeesList){
        users = JSON.parse(localStorage.getItem("users"))
        ACCESS_TOKEN = users.filter(function(el) {  if (el.email == email && el.type == account_type) { return el.access_token } })[0].access_token
        console.log(ACCESS_TOKEN)
        attendeesObj = []
        for (var i = attendeesList.length - 1; i >= 0; i--) {
          attendeesObj.push({ "email": attendeesList[i].trim() })
        }

        console.log(attendeesObj)
        $.ajax({
          method: "POST",
          url: `https://www.googleapis.com/calendar/v3/calendars/${email}/events?key=${API_KEY}`, 
          headers: { 
            'Authorization': `Bearer ${ACCESS_TOKEN}` 
          },
          data: JSON.stringify({
            "start": { "dateTime": from },
            "end": { "dateTime": to },
            "description": description,
            "summary": summary,
            "attendees": attendeesObj,
            "sendUpdates": "all"
          }),
          success: function(res){
            console.log(res)
            $('#myModal').modal('hide');
            update_event(email, ACCESS_TOKEN)
            // reload()     
          },
          error: function(err){
            console.log(err)
          }
        })
      }

      function arrangeEvents(){
        schs = JSON.parse(localStorage.getItem("schedules"))
        schedulesArray = []
        for (var i = schs.length - 1; i >= 0; i--) {
          schedulesArray.push(...schs[i].events)
        }

        console.log(schedulesArray)
        return schedulesArray
      }


      /**
       * Print the summary and start datetime/date of the next ten events in
       * the authorized user's calendar. If no events are found an
       * appropriate message is printed.
       */
      

        var calendarEl = document.getElementById('calendar');

        var calendar = new FullCalendar.Calendar(calendarEl, {
          initialDate: '2020-10-12',
          editable: true,
          selectable: true,
          lazyFetching: false,
          businessHours: true,
          dayMaxEvents: true, // allow "more" link when too many events
          events: arrangeEvents()
        });

        calendar.render();

    </script>

    <script async defer src="https://apis.google.com/js/api.js"
      onload="this.onload=function(){};handleClientLoad()"
      onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>
  
    <!-- Moment.js -->
    <script src="https://cdn.jsdelivr.net/npm/moment@2.27.0/moment.min.js"></script>
    <script src="https://momentjs.com/downloads/moment-timezone-with-data-10-year-range.js"></script>

    <!-- MSAL -->
    <script src="https://alcdn.msauth.net/browser/2.1.0/js/msal-browser.min.js"
            integrity="sha384-EmYPwkfj+VVmL1brMS1h6jUztl4QMS8Qq8xlZNgIT/luzg7MAzDVrRa2JxbNmk/e"
            crossorigin="anonymous"></script>

    <!-- Graph SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/microsoft-graph-client/lib/graph-js-sdk.js"></script>

    <script src="config.js"></script>
    <script src="timezones.js"></script>
    <script src="ui.js"></script>
    <script src="auth.js"></script>
    <script src="graph.js"></script>

  </body>
</html>